---
title: "MANOVA"
author: "Tamer Said"
date: "24/06/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Following Andy Field's codes 

```{r}
install.packages("car"); install.packages("ggplot2"); install.
packages("mvoutlier"); install.packages("mvnormtest"); install.
packages("pastecs"); install.packages("reshape"); install.
packages("WRS", repos="http://R-Forge.R-project.org")
library(car); library(ggplot2); library(MASS); library(mvoutlier);
library(mvnormtest); library(pastecs); library(reshape); library(WRS)
library(tidyverse)
library(ggpubr)
library(rstatix)
library(car)
library(broom)
```

#Data reshape: I resphaed the data in excel to mimik Fields' strcuture: New coloumn is inserted for group and will proceed in the MANOVA.rmd file

```{r}
PrePostCC <- read.csv("PrePostCC_wide-mod.csv")
```

Changing the group variable to factor with 2 levels

```{r}
PrePostCC$Group<-factor(PrePostCC$Group, levels = c("Pre", "Post"))
```

```{r}
library(pastecs)
```

Doing a comparative analysis for Q08 between pre and post
```{r}
by(PrePostCC$Q08, PrePostCC$Group, stat.desc, basic = FALSE)
```

```{r}
describeBy(PrePostCC, group = "Group")
```

Checking Homogeneity of covariance matrices (code did not work)

```{r}
cov("Q08":"Q24", use = "complete.obs")
```


```{r}
by(PrePostCC[, 3:18], PrePostCC$Group, cov)
```

#Data visualization

```{r}
ggboxplot(
  PrePost_mean, x = "Question", y = c("PreValue", "Post.Value"), 
  merge = TRUE, palette = "jco"
  )
```

Plotting for outliers (based on the box plot above, Q08 & Q22, showed to be outlires, I can specifically look for outliers )


```{r}
PrePostCC %>%
  group_by(Group) %>%
  identify_outliers(Q08) # 120 rows were identified
```

```{r}
PrePostCC %>%
  group_by(Group) %>%
  identify_outliers(Q22)
```
77 inputs showed to be outliers

<<<<<<< HEAD

#Mutlivariate ouliers: 
The Mahalanobis distance is generally used to detect multivariate outliers. The distance tells us how far an observation is from the center of the cloud, taking into account the shape (covariance) of the cloud as well.

Nothing was identified using this test..

```{r}
# Compute distance by groups and filter outliers
# Use -id to omit the id column in the computation
PrePostCC %>%
 group_by(Group) %>%
 mahalanobis_distance %>%
 filter(is.outlier == TRUE) %>%
  as.data.frame()
```
#Check linearity assumption

The pairwise relationship between the outcome variables should be linear for each group. This can be checked visually by creating a scatter plot matrix using the R function

```{r}
library(GGally)
results <- PrePostCC %>%
  select(Q08:Q24) %>%
  group_by("Group") %>%
  doo(~ggpairs(.) + theme_bw(), result = "plots")
results$plots
```


#Check univariate normality assumption

The normality assumption can be checked by computing Shapiro-Wilk test for each outcome variable at each level of the grouping variable. If the data is normally distributed, the p-value should be greater than 0.05.

```{r}
PrePostCC %>%
  group_by(Group) %>%
  shapiro_test(Q08, Q09, Q10, Q11, Q12, Q13, Q14, Q15, Q16, Q17, Q18, Q19, Q20, Q21, Q22, Q24) %>%
  arrange(variable)
```

All the data shows that they are NOT normally distributed. This is expected since the data is binomial. 

The same can be done using QQ plots (in this case they are meaningless since the data is binomial)

#Identify multicollinearity


Cor_mat command allows for a correlation matrix for more than 2 variables
```{r}
  PrePostCor <- cor_mat(PrePostCC_Wide, method = "spearman")
```

```{r}
write.csv(PrePostCor, "PrePostCC_Corr.csv")
```

#Check the homogeneity of covariances assumption:
Using the Box’s M-test

Note from Field : Box’s test is notoriously susceptible
to deviations from multivariate normality and so can be non-significant not because the matrices are similar, but because the assumption of multivariate normality is not tenable.

Removing IDs from the matrix
```{r}
PrePostCC2 <- select(PrePostCC, -ID)
```


```{r}
box_m(PrePostCC2, group = "Group")
```

#Transforming data to long format
Gathering questions under key variable: Question and value


```{r}
PrePostCC2 <- PrePostCC %>% 
  gather(key = "Question", value = "value", Q08, Q09, Q10, Q11, Q12, Q13, Q14, Q15, Q16, Q17, Q18, Q19, Q20, Q21, Q22, Q24) %>%
  group_by(Question) %>%
  levene_test(value ~ Group)
```
The Levene’s test is significant (p < 0.05), for most of the questions, except for : Q09, Q10, Q11, Q12, Q13, Q17, Q24.

#MANOVA model

```{r}
#newModel<-manova(outcome ~ predictor(s), data = dataFrame, na.action = na.exclude()

PrePostModel<-manova(Question ~ Group, data = PrePostCC2, na.action = na.exclude)   
```

Error from code: NAs introduced by coercionError in lm.fit(x, y, offset = offset, singular.ok = singular.ok, ...) : 
  NA/NaN/Inf in 'y'

Trying out another code


=======

#Mutlivariate ouliers: 
The Mahalanobis distance is generally used to detect multivariate outliers. The distance tells us how far an observation is from the center of the cloud, taking into account the shape (covariance) of the cloud as well.


```{r}
# Compute distance by groups and filter outliers
# Use -id to omit the id column in the computation
PrePostCC %>%
 group_by(Group) %>%
 mahalanobis_distance %>%
 filter(is.outlier == TRUE) %>%
  as.data.frame()

```

Nothing was identified using this test..

#Check univariate normality assumption

The normality assumption can be checked by computing Shapiro-Wilk test for each outcome variable at each level of the grouping variable. If the data is normally distributed, the p-value should be greater than 0.05.

```{r}
PrePostCC %>%
  group_by(Group) %>%
  shapiro_test(Q08, Q09, Q10, Q11, Q12, Q13, Q14, Q15, Q16, Q17, Q18, Q19, Q20, Q21, Q22, Q24) %>%
  arrange(variable)
```

All the data shows that they are NOT normally distributed. This is expected since the data is binomial. 


```{r}
aq.plot(PrePostCC[, 3:18])
```

#MANOVA model

newModel<-manova(outcome ~ predictor(s), data = dataFrame, na.action = na.exclude()

```{r}
PrePostCC %>%
Question <- cbind("Q08":"Q24")
```

>>>>>>> a49556fcaf1bc7200eddd3a2dac702e48a680ce6

```{r}
newModel<-manova(cbind(Q08:Q24)~ Group, data = PrePostCC, na.action = na.exclude)
```

```{r}
PrePost_mean <- read.csv("PrePostCC_mean.csv")
```


```{r}
meanModel <- manova (Question ~ cbind(PreValue, Post.Value), data = PrePost_mean,na.action = na.exclude)
<<<<<<< HEAD
```

```{r}
FIT <- lm(PrePostCC2$Group~PrePostCC2$value)
FIT
abline(reg = FIT)
=======
>>>>>>> a49556fcaf1bc7200eddd3a2dac702e48a680ce6
```

