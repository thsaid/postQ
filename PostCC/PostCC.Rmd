---
title: "Post CC"
author: "Tamer Said"
date: "04/08/2020"
output: html_document
---



To load the library
```{r}
library(tidyverse)
```

```{r}
postQ <- read.csv("Post Questionnaire.csv")
```


To select the variables for the postCC (SC) represents the score)
```{r}
PostCC <- select(postQ, Q1:Q4,SC0)
```

To delete the 2nd row 
```{r}
PostCC <- PostCC[-2,]
```



To rename the variables, you do not have to use the pipes, but in this case you will have to indicate the name of the dataset

```{r}
PostCC%>% 
  rename(ID= Q1, Picture= Q2, Color= Q3, Gender= Q4, Score=SC0)
```
The command below will remove the missing values implicitly 
```{r}
PostCC <- filter(PostCC, Q1>1)
```
To arrange the data according to ID 
```{r}
arrange(PostCC, Q1)
```
Let's try to arrange the result accorind to score

```{r}
arrange(PostCC, SC0)
```

From this arrangement, it appeared that some students have not filled the questionnaire, so I need to arrange the scores accordingly, and remove those without scores:I created the variable PostCC-Clean

```{r}
PostCC_Clean<- filter(PostCC, SC0 >=0)
PostCC_Clean
```
This code retrieved all the values that are greated than 1 and stored them in the variable PostCC_Clean. Let's check of there are still any missing values in SC0.

```{r}
filter(PostCC_Clean, !is.na(SC0))

```

This command resulted in the deletion of 6 observation, in which the score was missing. 

Renaming the variables

```{r}
PostCC_Clean <- rename(PostCC, ID=Q1, Picture= Q2, Color= Q3, PostCCScore= SC0)

```

lets print
```{r}
head(PostCC_Clean)
```

Again the cleaned variables were not saved, since I did not save the filter command in a new variable. I have to create a new one

```{r}
PostCC_Clean <- filter(PostCC_Clean, !is.na(PostCCScore))
PostCC_Clean
```
to check if there are still any missing values, I will arrange the values by score

```{r}
arrange(PostCC_Clean, PostCCScore)
```

There are still some missing values, I am not sure why they were not removed. 

```{r}
PostCC_Clean <- filter(PostCC, !is.na(SC0))

```

Still not working, wil try anohter one

```{r}
PostCC_Clean<- filter(PostCC, SC0 >=0)
```

This worked!! and 6 variables were removed.. let's check

Now, I need to arrange the rows according to IDs..

```{r}
PostCC_Clean <- arrange(PostCC, Q1)
```

When I ran this command, the missing values returned again. 

I am not sure, if I need to create a new variable to arrange the variables 

I will try to use the pipes to see where the problem is

```{r}
PostCC_Clean <- PostCC  %>%
  filter( SC0 >=0) %>%
  arrange(Q1)

```
Now it worked, the missing data were removed, then the data were arranged according to ID, I will now rename the variables.

```{r}
PostCC_Clean <- PostCC  %>%
  filter( SC0 >=0) %>%
  arrange(Q1 )%>%
  rename(ID= Q1, Picture =Q2, Color = Q3,Gender =Q4, PostCCScore = SC0)

```

```{r}
PostCC_Clean
```
Before merging the data, I need to make sure that there is a common coloumn that has the same name: ID

```{r}
SALES_scores <- rename(SALES_scores,ID= Q1)
```

Merge Data

In this section, I will merge the data from PostCC and SALES to see if there is any coorelation between PostCCScore and SALES score.

I will use the merge command to do so, based on ID. 

```{r}
CC_SALES <- merge(PostCC_Clean,SALES_scores,by = "ID")
```

As we can see i have got 392 observations, 6 variables 


Is it possible to merge by more than one critieria? I am going to try that

```{r}
CC_SALES <- merge(PostCC_Clean,SALES_scores,by = "ID", "Picture")
```

This did not work, since the SALES-Scores does not have picture, it's only ID.

```{r}
CC_SALES <- merge(PostCC_Clean,SALES_scores,by = "ID")
```

I want to try to filter all the NAs from postCC score inorder to convert it to a numeric variable


```{r}
filter(CC_SALES, !is.na(PostCCScore))
```

```{r}
CC_SALES <- filter(CC_SALES, !is.na(PostCCScore))
```

Converting PostCCSCore to numeric in order to do the correlations

```{r}
as.numeric(CC_SALES$PostCCScore)
```
New clean variable
```{r}
CC_SALESClean <- filter(CC_SALES, !is.na(PostCCScore))

```

There are still some variables that I do not want.. Will use another command to filter those unwanted ones. SOme ID numbers are not logical (ex. 8...), in this case, I need to select those ones since the filter command outputs a logical vector (True and false)

```{r}
CC_SALESClean <-CC_SALESClean[-393,]
```

```{r}
CC_SALESClean <-CC_SALESClean[-392,]
```

```{r}
CC_SALESClean <-CC_SALESClean[-391,]
```

```{r}
str(CC_SALESClean)
```

still , the postCCscore is character.. will try to convert it as integer.

Here I will refer to Andy field to see how I can change the variable from character to integer..
Loading packages from Andy field

```{r}
install.packages("Hmisc"); install.packages("ggm");
install.packages("ggplot2"); install.packages("polycor")
```

Converting PostCCScore to integer

```{r}
CC_SALES %>%
PostCCScore <- as.numeric(PostCCScore)
```

I kept getting an error message using the code above, so I had to create a new variable PoCC that is a numeric vector

```{r}
PoCC <- as.numeric(CC_SALES$PostCCScore)
```

Correlation test

```{r}
cor.test( CC_SALES$SS,PoCC)
```


PLOTS

I will start to do some plotting to see if there are any relationship between the scores

before doing a plot, we need to check the summary of the data using summary command

```{r}
summary(CC_SALES$SS)
```

Let's try a box plot to see the distribution of the Sales score

```{r}
boxplot(CC_SALES$SS, col = "blue")
```
Let's try the same for PostCC score

```{r}
boxplot(PoCC, col = "blue")
```
Histogram
```{r}
hist(CC_SALES$SS)
```

After seeing the plots, it appears that there are some outliers (over 200), since the maximum score is 125 (25*5), maybe some students have done the survey twice, which could skew the data.. I will create a new varaible and include only the ones less than or equal 125

```{r}
SSNew <- filter(CC_SALES, SS <= 125)
```

This command rendered 353 observations instead of 375..

Will try a scatter plot now and see if the relation changes after removing the outliers

```{r}
hist(SSNew$SS)
```
After removing the outliers, we can see that the Sales score is normally distrubuted, but is left skewed.

Let's see the scatter plot between the new SS and Post CC


```{r}
mygraph <- ggplot(CC_SALESClean, aes(SS, PostCCScore))
```
Now, I will specify the figure to be shown , e.x.point
```{r}
 mygraph + geom_point()
```

We can change the size of the point here

```{r}
mygraph + geom_point(size = .5)
```
This graphs allows for a boxplot that shows the difference bet gender in the sales score

```{r}
 boxplot(SS ~ Gender, CC_SALES)
```


```{r}
mygraph + geom_point(aes(colour = Gender))
```

#My work on 26/5/2021

libraries

```{r}
library(ltm)
library(mirt)
library(tidyverse)
library(polycor)
library(lavaan)
library(dplyr) 
library(tidyr)
library(psych)
library(mirt)
library(ltm)
library(ggpubr)
library(SmartEDA)
```


```{r}
PostQ <- read.csv("postQ_unique.csv")
```

```{r}
PostCC <- select(PostQ, ID, Q35:Q51)
```

```{r}
write.csv(PostCC, "PostCC.csv")
```


coonverting IDs to factors

```{r}
PostCC$ID <- factor(PostCC$ID)
```

#Replacing blank values with "NAs"
I discovered some blank responses, and I need to replace them by NAs (since the system recongize them as not blank or not missing)

```{r}
PostCC <- read.csv("PostCC.csv",header = T, na.strings=c(""," ","NA"))
```


Replacing NAs (for now, I will replace them, later I can do multiple imputations). I noticed that Q23 has only 20 responses. I will deselect it for now. Q7 is a qualitative question, so it will be deseclted for now.

#Renaming variables: I need to rename the questions to the same names as the pre in order to refer to do the comparative analysis.

```{r}
 PostCC <- rename(PostCC, Q08post=Q35, Q09post= Q36, Q10post= Q37, Q11post= Q38, Q12post = Q39, Q13post= Q40, Q14post = Q41, Q15post = Q42, Q16post= Q43, Q17post = Q44, Q18post = Q45, Q19post = Q46, Q20post = Q47, Q21post = Q48, Q22post = Q49, Q24post = Q51)
```



```{r}
PostCC <- select (PostCC, ID:Q24post)
```


```{r}
write.csv(PostCC, "PostCC.csv")
```

Converting data to long format

```{r}
PostCC_long <- gather(PostCC, Question, Response, Q08post:Q24post, factor_key=TRUE)
```

```{r}
PostCC_long %>%
select(ID:Response)
```
Descriptive analysis: Frequency analysis
```{r}
PostCC_Frequency <- ExpCustomStat(PostCC,Cvar = c("Q08post","Q09post","Q10post", "Q11post", "Q12post", "Q13post", "Q14post", "Q15post", "Q16post", "Q17post", "Q18post", "Q19post", "Q20post", "Q21post", "Q22post", "Q24post"), gpby= FALSE)
```

```{r}
write.csv(PostCC_Frequency, "PostCC_Frequencies.csv")
```

```{r}
scoring <- read.csv("scoring_CCcopy.csv")
```

```{r}
scoring2 <- read.csv("Scoring_CC2_copy.csv")
```

```{r}
PostCCscores2 <- inner_join(PostCC_long, scoring2, c("Response"))
```

Exporting the PostCC scores

```{r}
write.csv(PostCCscores2, "PostCCscores.csv")
```

```{r}
PreCCscores <- read.csv("PreCCscores_Complete.csv")
```


```{r}

PreCCscores <- dplyr:: select (PreCCscores, ID, Question:value) %>%
rename(PreValue = value)
```

```{r}

PostCCscores <- dplyr:: select (PostCCscores, ID, Question:value) %>%
rename(PostValue = value)
```

#Joining the pre and post tables

Renaming the questions



```{r}
PrePostCC <- inner_join(PreCCscores, PostCCscores, by ="ID")
```


```{r}
PostCC2 <- rename(PostCC2, Q08=Q35, Q09= Q36, Q10= Q37, Q11= Q38, Q12 = Q39, Q13= Q40, Q14 = Q41, Q15 = Q42, Q16= Q43, Q17 = Q44, Q18 = Q45, Q19 = Q46, Q20 = Q47, Q21 = Q48, Q22= Q49, Q24 = Q51)
```

```{r}
PostCC_long2 <- gather(PostCC2, Question, Response, Q08:Q24, factor_key=TRUE)
```

```{r}
PostCCscores2 <- inner_join(PostCC_long2, scoring2, c("Response"))
```

```{r}
PostCCscoresleft <- left_join(PostCC_long, scoring2, c("Response"))
```

```{r}
PostCCscores2 <- PostCCscores2 %>% 
  rename(PostValue= value) %>% 
  select(ID:PostValue)
```

```{r}
write.csv(PostCCscores, "PostCCscores.csv")
```

```{r}
write.csv(PostCCscores_left, "PostCCscoresNA.csv")
```

Individual scores

```{r}
Indvidual_PostCCScores <- group_by(PostCCscores,ID) %>% 
             summarise(Score = sum(value))
```

```{r}
Indvidual_PostCCScores <- rename(Indvidual_PostCCScores,
  PostScore = "Score")
```

```{r}
IndPreCC <- read.csv("Individual_PreCCscores.csv")
```

```{r}
ggplot(PrePostlong, aes(fill=Time, y=Score, x=Question)) + 
    geom_col(position="dodge", stat = "identity")
```

#Joining both tables to compare the scores of individuals

```{r}
PrePostInd <- inner_join(Indvidual_PostCCScores, IndPreCC, c("ID"))
```

```{r}
PrePostInd <- select(PrePostInd, -X)
```

```{r}
write.csv(PrePostInd, "PrePostCCInd.csv")
```

```{r}
PrePostInd_long <- gather(PrePostInd, Time, Score, PreScore, PostScore)
```

#Comparision of individual scores (pre/post)
```{r}
ggplot(PrePostInd_long, aes(fill=Time, y=Score, x=ID)) + 
    geom_col(position="dodge", stat = "identity")
```


```{r}
PreCCscores <- rename(PreCCscores,PreValue= PostValue ) 
```

Joining the pre and post again after leaving the Questions name as is

```{r}
PrePostCC <- inner_join(PreCCscores, PostCCscores2, c("ID","Question"))
```
Nothing resulted, since the questions are named differenrlty, 

```{r}
PrePostCC <- inner_join(PreCCscores, PostCCscores2, c("ID"))
```

This code worked, but each student has two different scores, one for pre and one for post

De-seclecting responses
```{r}
PrePostCC<- dplyr:: select(PrePostCC, - "Response.x", - "Response.y")
```

#Converting data to wide format

Frequency analysis (This works only one wide data not long)

```{r}
PrePostCC_Frequency <- ExpCustomStat(PrePostCC2,Cvar = c("Q08","Q9","Q10", "Q11", "Q12", "Q13", "Q14", "Q15", "Q16", "Q17", "Q18", "Q19", "Q20", "Q21", "Q22", "Q24"), gpby= FALSE)
```

```{r}
PrePostCC_Frequency <- ExpCustomStat(PrePostCC,Cvar = c("PreValue", "PostValue"), gpby= FALSE)
```
```

Description by ID
```{r}
describe.by(PrePostCC, "ID")
```

```{r}
describe.by(PrePostCC, "Response")
```
Exporting prepost scores 

```{r}
write.csv(PrePostCC, "PrePostCC.csv")
```

#Comparative plots

```{r}
ggbarplot(PrePostCC, x = "Question", y = "PreValue")
```

```{r}
ggbarplot(PrePostCC, x = "Question", y = "PostValue")
```

```{r}
p1 <- ggplot(PrePostCC, aes( y=PreValue, x=Question))  
   
```
Trying Violin chart
```{r}
p2 <- ggplot(PrePostCC, aes(x=Question, y=PostValue))

```

```{r}
geom_bar()
```

```{r}
ggplot(PrePostCC, aes(x=Question), y=PreValue) + 
ggplot(PrePostCC, aes(x=Question, y=PostValue))
 geom_bar(position="", stat="identity")
```

```{r}
ggplot(data = PrePostCC) + 
  geom_col(aes(x = Question, y = PreValue)) +
  par(new = TRUE) +
  geom_col(aes(x = Question, y = PostValue)) 
geom_bar(position="stack", stat="identity") 

```

```{r}
ggplot(data = PrePostCC) + 
  geom_col(aes(x = Question, y = PreValue, PostValue))
```



```{r}
data = PrePostCC %>%
plot(x = "Question", y= "PreValue", pch = 16, col = 2)              # Create first plot
par(new = TRUE)                             # Add new plot
plot(x = "Question", y= "PostValue", pch = 17, col = 3,              # Create second plot without axes
     axes = FALSE, xlab = "", ylab = "")
axis(side = 4, at = pretty(range(y2)))      # Add second axis
mtext("y2", side = 4, line = 3)             # Add second axis label
```

Converting data to long in order to put the time as condition to graph it
```{r}
medium <- select(PrePostCC, ID, Question, PreValue, PostValue)
```

```{r}
PrePostlong <- gather(medium, Time, Score , PreValue:PostValue, factor_key=TRUE)
```

```{r}
PrePostlong %>% 
             group_by(ID,Question)
            

```


```{r}
ggplot(PrePostlong, aes(fill=Time, y=Score, x=Question)) + 
    geom_bar(position="stack", stat="identity")
```

```{r}
ggplot(PrePostlong, aes(fill=Time, y=Score, x=Question)) + 
    geom_col(position="dodge", stat = "identity")
```

Violin Charts

```{r}
Violin = PrePostlong %>%
ggplot(aes(fill=Time, y=Score, x=Question)) + 
    geom_violin(position="dodge", alpha=0.5) 
Violin
```


Density chart
```{r}
PrePostlong %>%
ggplot(aes(fill=Time, y=Score, x=Question)) + 
     geom_density(adjust=1.5, alpha=.4) 
```
Did not work well

Lolipop charts
```{r}
ggplot(PrePostlong, aes(x=Question, y=Score)) +
  geom_point() + 
  geom_segment( aes(x=Question, xend=Question, y=0, yend=Score))
```

```{r}
ggplot(PrePostCC) +
geom_segment( aes(x=Question, xend=Question, y=PreValue, yend=PostValue), color="grey") +
  geom_point( aes(x=Question, y=PreValue), color=rgb(0.2,0.7,0.1,0.5), size=3 ) +
  geom_point( aes(x=Question, y=PostValue), color=rgb(0.7,0.2,0.1,0.5), size=3 )
```

#To do , after joinng the pre table, do a description like this to have a table of the pre and post values and compare the means and SD of each question.(15/6)

```{r}
library(hrbrthemes)
```

