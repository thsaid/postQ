---
title: "SEM"
author: "Tamer Said"
date: "26/07/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse) # For data wrangling
library(lavaan) # For CFA/MI/SEM
library(semPlot) # For CFA/MI/SEM
library (semTools) # For CFA/MI/SEM
library(OpenMx) # For SEM

```

Converting from corr to cov

```{r}
covmat <- cor2cov(Cormat)
```
 did not work because SDs are missing
 
```{r}
CC_SA_PA_SS <- CC_SA_PA_SS %>%
  rename(SE_S = SelfEfficacy)
```
 
 Building measurement model (model 1 leaving unique construcst and combining like terms together)
 
```{r}

CFAmodel <- 'MasteryGoals =~ MG_S + MG_P
Task_Value =~ TV
SelfEfficacy =~ SE_P + SE_S
PerfGoals =~ PAp
PerfAvoidance =~ PAV
Inhibition =~ SS_ACC
Learning =~ Gain
Learning ~  Task_Value + MasteryGoals + SelfEfficacy + PerfGoals + PerfAvoidance + Inhibition'

```
 
```{r}
 
SEMfit <- sem(CFAmodel, data = CC_SA_PA_SS, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit)
varTable(SEMfit)
parameterEstimates(SEMfit)
# Plot the model - this model plot below shows up as a black & white plot with standardized parameter estimates
semPaths(SEMfit, what = "path", whatLabels = "std", style = "lisrel", layout = "spring", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = TRUE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 10, sizeMan2 = 10, sizeLat = 10, sizeLat2 = 10, sizeInt = 6, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
lavResiduals(SEMfit)
```
 The fit of this model is poor.. 
 
 #Model 2: will try motivation as a whole latent
 
 
```{r}
model2 <- 'Motivation =~ MG_S + MG_P + TV
+ SE_P + SE_S
+ PAp
PerfAvoidance =~ PAV
Inhibition =~ SS_ACC
Learning =~ Gain
Learning ~  Motivation + PerfAvoidance + Inhibition'
```
 
```{r}
SEMfit2 <- sem(model2, data = CC_SA_PA_SS, se = "robust",   test = "Satorra-Bentler")
summary(SEMfit, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit2)
varTable(SEMfit2)
parameterEstimates(SEMfit2)
# Plot the model - this model plot below shows up as a black & white plot with standardized parameter estimates
semPaths(SEMfit2, what = "path", whatLabels = "std", style = "lisrel", layout = "spring", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = TRUE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 10, sizeMan2 = 10, sizeLat = 10, sizeLat2 = 10, sizeInt = 6, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
lavResiduals(SEMfit)
```
 
Trying ordinal values (Not applicable since I am ysing factor scores, which is continuous)

```{r}
SEMfit2 <- sem(model2, data = CC_SA_PA_SS, se = "robust",   test = "Satorra-Bentler")
summary(SEMfit2 , rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit2)
varTable(SEMfit2)
parameterEstimates(SEMfit2)
# Plot the model - this model plot below shows up as a black & white plot with standardized parameter estimates
semPaths(SEMfit2, what = "path", whatLabels = "std", style = "lisrel", layout = "spring", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = TRUE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 10, sizeMan2 = 10, sizeLat = 10, sizeLat2 = 10, sizeInt = 6, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
lavResiduals(SEMfit)
```

#SALES_Model

```{r}
SALESmodelSEM <- 'MG =~ MasteryGoals
TV =~ TV 
SE =~SelfEfficacy
PostScore ~  MG + SE + TV'
```


```{r}
PrePost <- read.csv("PrePostCCInd.csv")
```

```{r}
CC_SALES <- merge(PrePost, SALES_Factors, by = "ID")
```

```{r}
SEMfit4 <- sem(SALESmodelSEM, data = CC_SALES, se = "robust",   test = "Satorra-Bentler")
summary(SEMfit4 , rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit4)
varTable(SEMfit4)
parameterEstimates(SEMfit4)
# Plot the model - this model plot below shows up as a black & white plot with standardized parameter estimates
semPaths(SEMfit4, what = "path", whatLabels = "std", style = "lisrel", layout = "spring", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = TRUE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 10, sizeMan2 = 10, sizeLat = 10, sizeLat2 = 10, sizeInt = 6, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
lavResiduals(SEMfit)
```

#Model 3

Dividing motivaiton into MG/TV, and SE and testing the net gain is the outcome variable 

```{r}
model3 <- 'SALES =~ MG_S + TV + SE_S
SE =~SE_P 
PG =~PAp
PerfAvoidance =~ PAV
Inhibition =~ SS_ACC
Gain ~  MG_TV + SE + PerfAvoidance + Inhibition'
```


```{r}
SEMfit3 <- sem(model3, data = CC_SA_PA_SS, se = "robust",   test = "Satorra-Bentler")
summary(SEMfit3 , rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit3)
varTable(SEMfit3)
parameterEstimates(SEMfit3)
# Plot the model - this model plot below shows up as a black & white plot with standardized parameter estimates
semPaths(SEMfit3, what = "path", whatLabels = "std", style = "lisrel", layout = "spring", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = TRUE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 10, sizeMan2 = 10, sizeLat = 10, sizeLat2 = 10, sizeInt = 6, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
lavResiduals(SEMfit)
```


#Model 3.1

Dividing motivation into MG/TV, and SE and testing the postscore is the outcome variable 

```{r}
model3.1 <- 'SALES =~ MG_S + TV + SE_S
SE =~SE_P 
PG =~PAp
PerfAvoidance =~ PAV
Inhibition =~ SS_ACC
PostScore ~  SALES + SE + PG + PerfAvoidance + Inhibition'
```


```{r}
SEMfit3.1 <- sem(model3.1, data = CC_SA_PA_SS, se = "robust",   test = "Satorra-Bentler")
summary(SEMfit3.1 , rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit3.1)
varTable(SEMfit3)
parameterEstimates(SEMfit3.1)
# Plot the model - this model plot below shows up as a black & white plot with standardized parameter estimates
semPaths(SEMfit3.1, what = "path", whatLabels = "std", style = "lisrel", layout = "spring", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = TRUE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 10, sizeMan2 = 10, sizeLat = 10, sizeLat2 = 10, sizeInt = 6, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
lavResiduals(SEMfit3.1)
```
This model is the best fit so far.. 2 changes so far: having postscore is the outcome variable, and then putting the SALES sub-constructs together. 

Trying the same model using gain score as the outcome variable 

```{r}
model3.2 <- 'SALES =~ MG_S + TV + SE_S
SE =~SE_P 
PG =~PAp
PerfAvoidance =~ PAV
Inhibition =~ SS_ACC
Gain ~  SALES + SE + PG + PerfAvoidance + Inhibition'
```



```{r}
SEMfit3.2 <- sem(model3.2, data = data, se = "robust",   test = "Satorra-Bentler")
summary(SEMfit3.2 , rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit3.2)
varTable(SEMfit3.2)
parameterEstimates(SEMfit3.2)
# Plot the model - this model plot below shows up as a black & white plot with standardized parameter estimates
semPaths(SEMfit3.2, what = "path", whatLabels = "std", style = "lisrel", layout = "spring", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = TRUE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 10, sizeMan2 = 10, sizeLat = 10, sizeLat2 = 10, sizeInt = 6, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
lavResiduals(SEMfit3.2)
```

Best model till now 
#Trying out path models(from CB course)

#Renaming some variables before we start (I'm gonna name it data for short)

```{r}
data <- rename(CC_SALES_PALS_SS_FM, SS_EFF = Eff2,  SS_ACC = Average.of.ACC ,FM_EFF = EFF2)
```


```{r}
#fitting path analysis model
pathmodel.1 <- '
              #regressions
             Gain ~  PreScore + PostScore + FM_EFF + SS_EFF
              FM_EFF ~ MG_S + TV + SE_S + SE_P + PAp
           SS_EFF ~ MG_S + TV + SE_S + SE_P + PAp
          PostScore ~ MG_S + TV + SE_S + SE_P + PAp
          PreScore ~ MG_S + TV + SE_S + SE_P + PAp

              #covariances
              PreScore ~~ PostScore
              FM_EFF ~~ SS_EFF '
```

The followin error appeared: sample covariance matrix is not positive-definite


Trying another model (just EF & motivation )

```{r}
pathmodel.1 <- '
              #regressions
            FM_ACC_mean ~ MG_S + TV + SE_S + SE_P + PAp
           SS_ACC ~ MG_S + TV + SE_S + SE_P + PAp
FM_ACC_mean ~~  SS_ACC
'
```
  
  FM_ACC_mean ~ MG_S + TV + SE_S + SE_P + PAp
           SS_EFF ~ MG_S + TV + SE_S + SE_P + PAp
              #covariances '

```{r}
fit <- sem(pathmodel.1, data=data, meanstructure=TRUE)
summary(fit, standardized=TRUE, rsquare=TRUE, fit.measures = TRUE)
summary(fit, std.nox=TRUE, rsquare=TRUE)
```
```{r}
cov(data)
```


The only sig. effect is the -ve relation between PERFAPP goals and ACC in both stopsignal and FM tasks


```{r}
fitted(fit) #this command shows the model implied cov matrix
resid(fit, type="raw") #observed model - implied model 
resid(fit, type="normalized")
```
It seems that the diff between the model implied cov and the observed one does not differ at all. 

#Pathmodel 2: testing the relation between EF & CC, having motivation variables as mediators

```{r}
pathmodel2 <- '
              #regressions
              PostScore ~  FM_ACC_mean + SS_ACC 
              FM_ACC_mean ~ MG_S + TV + SE_S 
             SS_ACC ~ MG_S + TV + SE_S 
FM_ACC_mean ~~  SS_ACC
'
```

```{r}
fit2 <- sem(pathmodel2, data=data, meanstructure=TRUE)
summary(fit, standardized=TRUE, rsquare=TRUE, fit.measures = TRUE)
```

```{r}
resid(fit, type="raw") #observed model - implied model 
resid(fit, type="normalized")
```

Comparing booth models using likelihood test( it's not really a fair comparision here, because the no. of variables is different)

```{r}
lavTestLRT(fit2, fit)
```

It appreas that fit2 is much better

#Using Modification Indices

```{r}
modindices(fit2, sort. = TRUE)
```
Very minimal MI, nothing above 10. 

lhs: left hand side of the eq (DV).. the MI indicates the expected change in chi square.. values below 10 are not really significant. Here it is suggested to allow the residuals between psot score & SS_ACC to covary.. but even this, does noot produce a huge change. 
#Testing indirect effect between motivation, EF and post cc

```{r}
effects <- '
              #regressions (redefing the indirect effects)
              PostScore ~  EF_P*FM_EFF2 + S_P*SS_ACC 
              FM_EFF2 ~ M_F*MG_S + T_F*TV + S_F*SE_S 
              SS_ACC ~ M_S*MG_S + T_S*TV + S_S*SE_S 


#Indirect effects 

 ind_F := M_F*T_F*S_F
 ind_S :=  M_S*T_S*S_S
'

set.seed(62973)
fit_eff <- sem(effects, data=FullData, meanstructure=TRUE, se="bootstrap", bootstrap=1000)
parameterEstimates(fit_eff, boot.ci.type = "perc")
parameterEstimates(fit_eff, boot.ci.type = "bca.simple") # biased corected CI..gold standard for mediation effect using bootstrapping 

```
The output shows that all the indirect effects are NOT significant they all pass the zero CI. 


Repeating SEM with allowing residuals to covary

model3.2 <- 'SALES =~ MG_S + TV + SE_S
SE =~SE_P 
PG =~PAp
PerfAvoidance =~ PAV
Inhibition =~ SS_ACC
Gain ~  SALES + SE + PG + PerfAvoidance + Inhibition'

```{r}
model4 <- 'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
PALS =~ MG_P + SE_P
Inhibition =~ SS_ACC
Switching  =~ FM_ACC_mean
Learning =~ PostScore 
Learning ~  SALES + PG + Inhibition + Switching + PreScore
Inhibition ~~ Switching '
```

```{r}
SEMfit4 <- sem(model4, data = data, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit4, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit4)
varTable(SEMfit4)
parameterEstimates(SEMfit4)
# Plot the model - this model plot below shows up as a black & white plot with standardized parameter estimates
semPaths(SEMfit4, what = "path", whatLabels = "std", style = "lisrel", layout = "spring", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = TRUE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 10, sizeMan2 = 10, sizeLat = 10, sizeLat2 = 10, sizeInt = 6, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
lavResiduals(SEMfit4)
```

Testing CFA models including switching & inhibition as one latent

```{r}
CFAmodel <- 
   'SALES =~ MG_S + TV + SE_S 
PG =~ PAV  + PAp
PALS =~ MG_P + SE_P
EF =~ SS_ACC + FM_ACC_mean
Learning =~ PostScore + Gain'
fit_CFA <- cfa(CFAmodel, data=data, meanstructure=TRUE, std.lv=TRUE)
summary(fit_CFA, fit.measures=TRUE, standardized=TRUE, rsquare=TRUE)

modindices(fit_CFA, sort.=TRUE, minimum.value=10)
```
Based on this model, the factor loading on EF latent is very low ..0.09 & 0.05 respectively. 

Let's try having a factor for inhibition & another for switching

```{r}
CFAmodel2 <- 
   'SALES =~ MG_S + TV + SE_S 
PG =~ PAV  + PAp
PALS =~ MG_P + SE_P
Inhibition =~ SS_ACC + Average.of.EFF
Switching  =~ FM_ACC_mean + FM_EFF_mean
Inhibition ~~ Switching
Learning =~ PostScore + Gain
'
fit_CFA2 <- cfa(CFAmodel2, data=data, meanstructure=TRUE, std.lv=TRUE)
summary(fit_CFA2, fit.measures=TRUE, standardized=TRUE, rsquare=TRUE)

modindices(fit_CFA2, sort.=TRUE, minimum.value=10)
```

Notes on CFA model 2, the inclusion of the EFF score, highly distorted the model,. It appears that something went wrong in calculating such score. 


Returning back to mdoel 4 and adding more mediation effects (EF as mediators)
Setting post score as the learning
```{r}
model5 <- 'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
PALS =~ MG_P + SE_P
Inhibition =~ SS_ACC
Switching  =~ FM_ACC_mean
Learning =~ PostScore 
Learning ~  Inhibition + Switching + PreScore + SALES
Inhibition ~ SALES + PALS
Switching ~ SALES + PALS '
```
In 5.1, gain will be the measurement of learning instead of post score

```{r}
model5.1 <- 'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
PALS =~ MG_P + SE_P
Inhibition =~ SS_ACC
Switching  =~ FM_ACC_mean
Learning =~ Gain
Learning ~  Inhibition + Switching + PreScore + SALES
Inhibition ~ SALES + PALS
Switching ~ SALES + PALS '
```


```{r}
SEMfit5.1 <- sem(model5.1, data = data, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit5.1, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit5.1)
varTable(SEMfit5.1)
parameterEstimates(SEMfit5.1)
# Plot the model - this model plot below shows up as a black & white plot with standardized parameter estimates
semPaths(SEMfit5.1, what = "path", whatLabels = "std", style = "lisrel", layout = "tree", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = FALSE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 5, sizeMan2 = 5, sizeLat = 5, sizeLat2 = 5, sizeInt = 4, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
lavResiduals(SEMfit4)
```
In model 5.1 (will gain is the learning predictor), the model fit is worse.. the only sig predictor of gain was inhibition. None of the other predictors had effect. 



in model 6, I will restrict any direct effect between SALES and learning 
```{r}
model6 <- 'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
PALS =~ MG_P + SE_P
Inhibition =~ SS_ACC
Switching  =~ FM_ACC_mean
Learning =~ PostScore 
Learning ~  Inhibition + Switching + PreScore 
Inhibition ~ SALES + PALS
Switching ~ SALES + PALS '
```

```{r}
SEMfit6 <- sem(model6, data = data, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit6, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit6)
varTable(SEMfit6)
parameterEstimates(SEMfit6)
# Plot the model - this model plot below shows up as a black & white plot with standardized parameter estimates
semPaths(SEMfit6, what = "path", whatLabels = "std", style = "lisrel", layout = "tree", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = FALSE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 5, sizeMan2 = 5, sizeLat = 5, sizeLat2 = 5, sizeInt = 4, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
lavResiduals(SEMfit4)
```
```{r}
modindices(SEMfit6, sort. = TRUE)
```
Based on the modification indices, it appeared that switching could be regressed by FM_ACC and vice versa.. will put EF under one latent and test it in model 7
#Model 7: putting switching & inhibition under one latent 

```{r}
model7<- 'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
PALS =~ MG_P + SE_P
EF =~ FM_EFF2 + SS_EFF + CB_EFF
Learning =~ PostScore 
Learning ~  EF + PreScore + SALES
EF ~ SALES + PALS'
```

```{r}
SEMfit7<- sem(model7, data = FullData, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit7, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit7)
varTable(SEMfit7)
parameterEstimates(SEMfit7)
# Plot the model - this model plot below shows up as a black & white plot with standardized parameter estimates
semPaths(SEMfit7, what = "path", whatLabels = "std", style = "lisrel", layout = "tree", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = FALSE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 5, sizeMan2 = 5, sizeLat = 5, sizeLat2 = 5, sizeInt = 4, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
lavResiduals(SEMfit7)
```
model 7.1 Canceling the direct effect between SALES and learning

```{r}
model7.1<- 'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
PALS =~ MG_P + SE_P
EF =~ FM_EFF2 + SS_EFF + CB_EFF
Learning =~ PostScore 
Learning ~  EF + PreScore 
EF ~ SALES + PALS'
```

```{r}
SEMfit7.1<- sem(model7.1, data = FullData, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit7.1, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit7.1)
varTable(SEMfit7.1)
parameterEstimates(SEMfit7.1)
```

The chisq difference between the 2 models is minimal (2.31) .. and the probability is not significant.. 0.14, which means that there is no significant difference between the two models. 

```{r}
lavTestLRT(SEMfit7.1, SEMfit7) #testing whether removing the direct effect improved the model or not.. 
```

All the models show an insignificant regression between EF & motivation


#Model 1: Full model including PALS


```{r}
model8<- 'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
PALS =~ MG_P + SE_P
EF =~ FM_EFF_Z + SS_EFF_Z + CB_EFF_Z 
Learning =~ PostScore 
Learning ~  EF + PreScore + SALES + PG + PALS + Age
EF ~ SALES + PG + PALS'

SEMfit8<- sem(model8, data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit8, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit8)
varTable(SEMfit8)
```


Removing SALES as predictor

```{r}
model8PALS<- 'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
PALS =~ MG_P + SE_P
EF =~ FM_EFF_Z + SS_EFF_Z + CB_EFF_Z 
Learning =~ PostScore 
Learning ~  EF + PreScore + PG + PALS + Age
EF ~ PG + PALS'
```
```{r}
SEMfit8PALS<- sem(model8PALS, data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit8PALS, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit8PALS)
varTable(SEMfit8PALS)
```

#Testing the effect of removing PALS 

```{r}
model8SALES<- 'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
PALS =~ MG_P + SE_P
EF =~ FM_EFF_Z + SS_EFF_Z + CB_EFF_Z 
Learning =~ PostScore 
Learning ~  EF + PreScore + PG + SALES + Age
EF ~ PG + SALES '
```

```{r}
SEMfit8SALES<- sem(model8SALES, data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit8SALES, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit8SALES)
varTable(SEMfit8SALES)
```


```{r}
SEMfit8<- sem(model8, data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit8, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit8)
varTable(SEMfit8)
parameterEstimates(SEMfit8)
# Plot the model - this model plot below shows up as a black & white plot with standardized parameter estimates
semPaths(SEMfit8, what = "path", whatLabels = "std", style = "lisrel", layout = "tree", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = FALSE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 5, sizeMan2 = 5, sizeLat = 5, sizeLat2 = 5, sizeInt = 4, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
lavResiduals(SEMfit7)
```
```{r}
modindices(SEMfit8, sort. = TRUE)
```


```{r}
lavTestLRT(SEMfit7, SEMfit8) #testing whether removing the direct effect improved the model or not.. 
```
It seems that model 8 has a better fit when comparing chi-sq. difference and pvalue, this shoows that including the link between PG & postscore is better. 

Model 8.1: Allowing SE_S & SE_P to covary 
```{r}
model8.1 <- 'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
EF =~ FM_EFF_Z+ SS_EFF_Z + CB_EFF_Z
Learning =~ PostScore 
Learning ~  EF + PreScore + SALES + PG + Age
EF ~ PG'
```
BY allowing the residuals to covary, the model fit improved alot from 0.96 to 0.98 and RMSEA too 0.04

```{r}
SEMfit8.1<- sem(model8.1, data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit8.1, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit8.1)
varTable(SEMfit8.1)
parameterEstimates(SEMfit8.1)
# Plot the model - this model plot below shows up as a black & white plot with standardized parameter estimates
semPaths(SEMfit8.1, what = "path", whatLabels = "std", style = "lisrel", layout = "tree", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = FALSE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 5, sizeMan2 = 5, sizeLat = 5, sizeLat2 = 5, sizeInt = 4, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
lavResiduals(SEMfit7)
```

```{r}
modelcopy <- 'Learning=~ PostScore

EF=~FM_EFF_Z+SS_EFF_Z+CB_EFF_Z

PG=~PAp+PAV

AGE=~Age

Pre_Score=~PreScore

SALES=~MG_S+TV+SE_S

Learning~EF+PG+AGE+Pre_Score+SALES'
```


```{r}
SEMfitcopy<- sem(modelcopy, data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfitcopy, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfitcopy)
varTable(SEMfitcopy)
parameterEstimates(SEMfitcopy)
```

```{r}
model9<-'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
EF =~ FM_EFF_Z + SS_EFF_Z + CB_EFF_Z
Learning =~ PostScore 
Learning ~  EF + PreScore + SALES + PG + Age'
```


```{r}
SEMfit9<- sem(model9, data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit9, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit9)
varTable(SEMfit9)
parameterEstimates(SEMfit9)
```

```{r}
compare_performance(SEMfit9, SEMfit8.1)
 %>%
  print_md()
```
```{r}
library(see)
plot(compare_performance(SEMfit9, SEMfit8.1))
```

Model9_age_EF
```{r}
model9.3<-'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
EF =~ FM_EFF_Z + SS_EFF_Z + CB_EFF_Z
Learning =~ PostScore 
Learning ~  EF + PreScore + SALES + PG + Age
EF ~ Age + PG'
SEMfit9.3<- sem(model9.3, data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit9.3, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit9.3)
varTable(SEMfit9.3)
parameterEstimates(SEMfit9.3)
```


```{r}
SEMfit9<- sem(model9, data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit9, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit9)
varTable(SEMfit9)
parameterEstimates(SEMfit9)
# Plot the model - this model plot below shows up as a black & white plot with standardized parameter estimates
semPaths(SEMfit9, what = "path", whatLabels = "std", style = "lisrel", layout = "tree", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = FALSE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 5, sizeMan2 = 5, sizeLat = 5, sizeLat2 = 5, sizeInt = 4, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
lavResiduals(SEMfit7)
```

The model improved after removing the mediated effect ()
Comparing the model with age and that is without


```{r}
lavTestLRT(SEMfit9, SEMfit9.3) #testing whether removing the direct effect improved the model or not.
```
```



Testing the nested models (8.1 & 9)

```{r}
lavTestLRT(SEMfit8.1, SEMfit9) #testing whether removing the direct effect improved the model or not.
```
```{r}
resid(SEMfit9, type="normalized")
$`type`
[1] "normalized"
```
Notes on residual covariance: values  > +/- 2 is meanigful. Nothing to worry about here.. all the values are less than 2. 

Can I have the outcome as a manifest variable? will try this out
```{r}
model8.2<- 'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
PALS =~ MG_P + SE_P
EF =~ SS_ACC + FM_ACC_mean
PostScore  ~  EF + PreScore + SALES + PG
EF ~ SALES + PALS'
```


```{r}
SEMfit8.2<- sem(model10, data = data, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit10, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit10)
varTable(SEMfit10)
parameterEstimates(SEMfit10)
```
Model 10: removing all motiv. variables to chekc the quality of the model

```{r}
model10<- '
EF =~ FM_EFF_Z + SS_EFF_Z + CB_EFF_Z
PostScore  ~  EF + PreScore 
'
SEMfit10<- sem(model10, data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit10, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit10)
varTable(SEMfit10)
parameterEstimates(SEMfit10)
```

Trying out motv. as predictors of prescores

```{r}
model11<- 'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
PALS =~ MG_P + SE_P
EF =~ FM_EFF_Z + SS_EFF_Z + CB_EFF_Z
PreScore ~ SALES + PALS + PG + EF
PostScore  ~  EF + PreScore 
EF ~ SALES + PALS'
```

```{r}
SEMfit11<- sem(model11, data = data, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit11, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit11)
varTable(SEMfit11)
parameterEstimates(SEMfit11)
```

#Testing indirect effects


```{r}
Ind_model <- '
SALES =~ MG_S + TV + SE_S
PALS =~ MG_P + SE_P
EF =~ FM_EFF2 + SS_EFF + CB_EFF
Learning =~ PostScore 
Learning ~  EF + PreScore + SALES + PG

Ind_S :=  S_EF
Ind_P := P_EF
Ind_PG := PG_EF
total_Ind := P_EF*S_EF*PG_EF

EF ~ PALS *P_EF + SALES*S_EF + PG*PG_EF + PreScore*Pre
Learning ~ SALES*S_L + PALS *P_L + PG*PG_L
dir:= P_L + S_L+PG_L+Pre
'

```

PG_ind <- ' SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
EF =~ FM_EFF_Z + SS_EFF_Z + CB_EFF_Z

PostScore ~  EF_Po*EF + S_Po*SALES + PG_Po*PG + PreScore
EF ~ PG_EF*PG 

#Indirect effects
PG_ind := PG_EF
dir := S_Po +  EF_Po - PG_Po 
'

```{r}
Ind_model <- ' SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
EF =~ FM_EFF_Z + SS_EFF_Z + CB_EFF_Z

PostScore ~  EF_Po*EF + S_Po*SALES + PG_Po*PG + PreScore
EF ~ PG_EF*PG + S_EF*SALES

#Indirect effects
PG_ind := PG_EF*S_EF*SALES
dir := S_Po +  EF_Po - PG_Po
'
```
#Indirect effects


```{r}
set.seed(5000)
fit_ind <- sem(Ind_model, data= FullData_Z, meanstructure=TRUE, se="bootstrap", bootstrap=1000)
parameterEstimates(fit_ind, boot.ci.type = "perc")
parameterEstimates(fit_ind, boot.ci.type = "bca.simple") # biased corected CI..gold standard for mediation effect using bootstrapping 
```

Calculating Z scores

```{r}
FullData %>% 
FM_EFF_Z <- scale(FM_EFF2, center = TRUE, scale = TRUE) %>%
SS_EF_Z <- scale(SS_EFF, center = TRUE, scale = TRUE)
CB_EFF_Z <- scale(CB_EFF, center = TRUE, scale = TRUE)
```



#Testing Mediation (using Buchanan)

Testing the direct effect between EF & Post score (already established in previous moodels )

```{r}
cpath = lm(PostScore ~ SS_EFF, data = FullData)
summary(cpath)
```
```{r}
#testing the relation between SE & SS_EFF

apath = lm(SE_S ~ SS_EFF, data = FullData)
summary(apath)
```


THis approach however, is not fully appropriate, since it does not bear in mind the relation between the latents. 

```{r}
library(ppcor)
library(corrplot)
cor.mat <- pcor(FullData[sapply(FullData, is.numeric)])
```

```{r}
corrplot(data)
```

```{r}
corrplot(FullData)
```

#19/9: Loading Z scores of Efficiency to avoid the huge gap between the tasks

```{r}
FullData_Z <- read.csv("FullData_Z-_190921.csv")
```
Model10: Removing PALS and examining the link between PG & Postscore, having EF as mediator, while removing link between SALES & EF (since it was not significant)

```{r}
model10<- 'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
EF =~ FM_EFF_Z + SS_EFF_Z + CB_EFF_Z
PostScore  ~  EF + PreScore + SALES + PG + Age
EF ~ PG '
```

```{r}
SEMfit10<- sem(model10, data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit10, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit10)
varTable(SEMfit10)
parameterEstimates(SEMfit10)

semPaths(SEMfit10, what = "path", whatLabels = "std", style = "lisrel", layout = "tree", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = FALSE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 5, sizeMan2 = 5, sizeLat = 5, sizeLat2 = 5, sizeInt = 4, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
lavResiduals(SEMfit10)
```
keeping also SALES & EF
```{r}
model10.1<- 'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
EF =~ FM_EFF_Z + SS_EFF_Z + CB_EFF_Z
PostScore  ~  EF + PreScore + SALES + PG + Age
EF ~ PG + SALES'
```

```{r}
SEMfit10.1<- sem(model10.1, data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit10.1, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit10.1)
varTable(SEMfit10.1)
parameterEstimates(SEMfit10.1)
```

```{r}
semPaths(SEMfit10.1, what = "path", whatLabels = "std", style = "lisrel", layout = "tree", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = FALSE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 5, sizeMan2 = 5, sizeLat = 5, sizeLat2 = 5, sizeInt = 4, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
```

Model 11: Examining model 10, without the link between EF & PG. 

```{r}
model11 <- 'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
EF =~ FM_EFF_Z + SS_EFF_Z + CB_EFF_Z
PostScore  ~  EF + PreScore + SALES + PG + Age  '
```

```{r}
SEMfit11<- sem(model11, data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit11, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit11)
varTable(SEMfit11)
parameterEstimates(SEMfit11)
```


```{r}
model11.1 <- 'SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
EF =~ FM_EFF_Z + SS_EFF_Z + CB_EFF_Z
PostScore  ~  EF + PreScore + SALES + PG + Age  '
```

```{r}
SEMfit11.1<- sem(model11.1, data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit11.1, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit11.1)
varTable(SEMfit11.1)
parameterEstimates(SEMfit11.1)
```


```{r}
SEMfit11<- sem(model11, data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit11, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit11)
varTable(SEMfit11)
parameterEstimates(SEMfit11)

semPaths(SEMfit11.1, what = "path", whatLabels = "std", style = "lisrel", layout = "tree", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = FALSE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 5, sizeMan2 = 5, sizeLat = 5, sizeLat2 = 5, sizeInt = 4, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
lavResiduals(SEMfit11)
```

```{r}
lavTestLRT(SEMfit10, SEMfit11)
```

```{r}
PG_ind2 <- ' SALES =~ MG_S + TV + SE_S
PG =~ PAV  + PAp
EF =~ FM_EFF_Z + SS_EFF_Z + CB_EFF_Z

PostScore ~  EF_Po*EF + S_Po*SALES + PG_Po*PG + PreScore + Age
EF ~ PG_EF*PG 

#Indirect effects
PG_ind := PG_EF*EF_Po
dir := S_Po +  EF_Po - PG_Po 
#Total effect 
total := (PG_EF*EF_Po) +S_Po +  EF_Po - PG_Po 

'
```

```{r}
fitPG_ind2<- sem(PG_ind2 , data = FullData_Z, se = "bootstrap")
summary(fitPG_ind2, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(fitPG_ind2)
varTable(fitPG_ind2)
parameterEstimates(fitPG_ind2)
```


```{r}
fitPG_ind<- sem(PG_ind2 , data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(fitPG_ind, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(fitPG_ind)
varTable(fitPG_ind)
parameterEstimates(fitPG_ind)
```


#22/09 code, examining full model inlcuding PALS to decide whether to include them or not and comparing it with moodel 9 that did not have it. 

```{r}
model12<- 'SALES =~ MG_S + TV + SE_S
PALS =~ MG_P + SE_P
Learning =~ PostScore 
Learning ~  EF + PreScore + SALES + PALS + PG + Age
PG =~ PAV  + PAp
EF =~ FM_EFF_Z + SS_EFF_Z + CB_EFF_Z
EF ~ SALES + PALS + PG
 '
```


```{r}
SEMfit12<- sem(model12, data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit12, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit12)
varTable(SEMfit12)
parameterEstimates(SEMfit12)

semPaths(SEMfit12, what = "path", whatLabels = "std", style = "lisrel", layout = "tree", 
         rotation = 2, curve = 1, curvature = 6, 
         intercepts = FALSE, residuals = FALSE, thresholds = FALSE, 
         nCharNodes = 10, nCharEdges = 0, 
         sizeMan = 5, sizeMan2 = 5, sizeLat = 5, sizeLat2 = 5, sizeInt = 4, sizeInt2 = 4)
# Check for correlated residuals in the model (note there are none, so no correlated residuals in the model)
lavResiduals(SEMfit12)
```

                
Let's test model 13 (inlcuding age)

```{r}
model13 <- 'SALES =~ MG_S + TV + SE_S
PostScore ~  EF + PreScore + SALES + PG + Age
PG =~ PAV  + PAp
EF =~ FM_EFF_Z + SS_EFF_Z + CB_EFF_Z 
EF ~  PG + SALES
'
```


```{r}
SEMfit13<- sem(model13, data = FullData_Z, se = "robust",   test = "Satorra-Bentler", meanstructure = TRUE)
summary(SEMfit13, rsq = TRUE, standardized = TRUE, fit = TRUE)
fitmeasures(SEMfit13)
varTable(SEMfit13)
parameterEstimates(SEMfit13)
```

```{r}
set.seed(62973)
fit_eff <- sem(PG_ind, data=FullData_Z, meanstructure=TRUE, se="bootstrap", bootstrap=1000)
parameterEstimates(fit_eff, boot.ci.type = "perc")
parameterEstimates(fit_eff, boot.ci.type = "bca.simple") # biased corected CI..gold standard for mediation effect using bootstrapping 
```


